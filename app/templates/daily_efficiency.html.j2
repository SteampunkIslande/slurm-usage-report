<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rapport d'efficacité du cluster - {{ date }}</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        h1,
        h2,
        h3 {
            color: #333;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background-color: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        th,
        td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #4CAF50;
            color: white;
        }

        tr:hover {
            background-color: #f5f5f5;
        }

        .summary {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .metric-value {
            font-weight: bold;
        }

        .percentage {
            color: #2196F3;
        }

        .time-value {
            color: #FF9800;
        }

        footer {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
            color: #666;
            font-size: 0.9em;
        }
    </style>
</head>

<body>
    <h1>Rapport d'efficacité du cluster - {{ date }}</h1>

    <h2>Présentation</h2>
    <p>
        Ce rapport quotidien mesure la charge de travail du cluster.
        Il rend compte de l'utilisation de deux types de ressources:
    <ul>
        <li>La mémoire vive, exprimée en GB.secondes, correspondant au produit entre la quantité totale disponible sur
            le
            serveur et la durée d'une journée en secondes. Sont indiqués (1) la valeur totale des consommations connues
            et (2) le taux d'occupation, rapporté aux capacités totales du cluster.</li>
        <li>
            Le temps CPU, exprimé en CPU.secondes, correspondant au produit entre le nombre de CPUs sur l'ensemble du
            cluster et la durée d'une journée en secondes. Ce qui est indiqué correspond au temps réellement utilisé par
            l'ensemble des CPUs, en considérant le temps d'attente pour les I/O comme du temps CPU inutile.
        </li>
    </ul>
    Attention, lorsque les jobs sont lancés avec podman, aucune mesure de la consommation réelle n'est possible, en
    raison du fonctionnement "daemon" de podman.
    </p>


    <div class="summary">
        <h3>Statistiques globales</h3>
        <table>
            <tr>
                <th>Métrique</th>
                <th>Valeur</th>
            </tr>
            <tr>
                <td>Total CPU (heures)</td>
                <td class="metric-value">{{ "%.2f"|format(global_metrics.get("CPU.Heures", 0) or 0) }} h</td>
            </tr>
            <tr>
                <td>Pourcentage d'utilisation CPU</td>
                <td class="metric-value percentage">{{ "%.2f"|format(global_metrics.get("Pourcentage d'utilisation CPU",
                    0) or 0) }} %</td>
            </tr>
            <tr>
                <td>Utilisation mémoire (GB.secondes)</td>
                <td class="metric-value">{{ "%.2f"|format(global_metrics.get("GB.Secondes", 0) or 0) }}</td>
            </tr>
            <tr>
                <td>Taux d'occupation de la RAM</td>
                <td class="metric-value percentage">{{ "%.2f"|format(global_metrics.get("Taux d'occupation de la RAM",
                    0) or 0) }} %</td>
            </tr>
            <tr>
                <td>Temps d'attente moyen en queue</td>
                <td class="metric-value time-value">{{ global_metrics.get("Temps d'attente moyen en queue (secondes)",
                    0)|format_duration }}</td>
            </tr>
            <tr>
                <td>Temps d'attente médian en queue</td>
                <td class="metric-value time-value">{{ global_metrics.get("Temps d'attente médian en queue (secondes)",
                    0)|format_duration }}</td>
            </tr>
            <tr>
                <td>Temps d'attente minimum en queue</td>
                <td class="metric-value time-value">{{ global_metrics.get("Temps d'attente minimum en queue (secondes)",
                    0)|format_duration }}</td>
            </tr>
            <tr>
                <td>Temps d'attente maximum en queue</td>
                <td class="metric-value time-value">{{ global_metrics.get("Temps d'attente maximum en queue (secondes)",
                    0)|format_duration }}</td>
            </tr>
            <tr>
                <td>Jobs terminés avec succès</td>
                <td class="metric-value"><span style="color: green;">{{ global_metrics.get("Jobs terminés avec succès")
                        }}</span></td>
            </tr>
            <tr>
                <td>Jobs échoués</td>
                <td class="metric-value"><span style="color: red;">{{ global_metrics.get("Jobs échoués") }}</span></td>
            </tr>
            <tr>
                <td>Jobs préemptés</td>
                <td class="metric-value"><span style="color: orange;">{{ global_metrics.get("Jobs préemptés") }}</span>
                </td>
            </tr>
            <tr>
                <td>Jobs soumis</td>
                <td class="metric-value">{{ global_metrics.get("Jobs soumis") }}</td>
            </tr>
            <tr>
                <td>Jobs démarrés</td>
                <td class="metric-value">{{ global_metrics.get("Jobs démarrés") }}</td>
            </tr>
            <tr>
                <td>Jobs terminés</td>
                <td class="metric-value">{{ global_metrics.get("Jobs terminés") }}</td>
            </tr>
            <tr>
                <td>Durée moyenne d'exécution</td>
                <td class="metric-value time-value">{{ global_metrics.get("Durée moyenne d'exécution (secondes)",
                    0) | format_duration }}</td>
            </tr>
            <tr>
                <td>Durée médiane d'exécution</td>
                <td class="metric-value time-value">{{ global_metrics.get("Durée médiane d'exécution (secondes)",
                    0) | format_duration }}</td>
            </tr>
            <tr>
                <td>Durée minimum d'exécution</td>
                <td class="metric-value time-value">{{ global_metrics.get("Durée minimum d'exécution (secondes)",
                    0) | format_duration }}</td>
            </tr>
            <tr>
                <td>Durée maximum d'exécution</td>
                <td class="metric-value time-value">{{ global_metrics.get("Durée maximum d'exécution (secondes)",
                    0) | format_duration }}</td>
            </tr>
        </table>
    </div>

    {% if qos_metrics %}
    <div class="summary">
        <h3>Détails par QOS</h3>
        <p>
            Les métriques sont également ventilées par QOS (Quality of Service), ce qui permet d'identifier les classes
            de jobs les plus consommatrices de ressources ou les plus sujettes à des temps d'attente en queue élevés.
        </p>
        {% for qos_name, qos_data in qos_metrics.items() %}
        <h4>QOS: {{ qos_name }}</h4>
        <table>
            <tr>
                <th>Métrique</th>
                <th>Valeur</th>
            </tr>
            <tr>
                <td>CPU (heures)</td>
                <td class="metric-value">{{ "%.2f"|format(qos_data.get("CPU.Heures", 0) or 0) }} h</td>
            </tr>
            <tr>
                <td>Pourcentage d'utilisation CPU</td>
                <td class="metric-value percentage">{{ "%.2f"|format(qos_data.get("Pourcentage d'utilisation CPU", 0) or
                    0) }} %</td>
            </tr>
            <tr>
                <td>Utilisation mémoire (GB.secondes)</td>
                <td class="metric-value">{{ "%.2f"|format(qos_data.get("GB.Secondes", 0) or 0) }}</td>
            </tr>
            <tr>
                <td>Taux d'occupation de la RAM</td>
                <td class="metric-value percentage">{{ "%.2f"|format(qos_data.get("Taux d'occupation de la RAM", 0) or
                    0) }} %</td>
            </tr>
            <tr>
                <td>Temps d'attente moyen en queue</td>
                <td class="metric-value time-value">{{ qos_data.get("Temps d'attente moyen en queue (secondes)",
                    0)|format_duration }}</td>
            </tr>
            <tr>
                <td>Temps d'attente médian en queue</td>
                <td class="metric-value time-value">{{ qos_data.get("Temps d'attente médian en queue (secondes)",
                    0)|format_duration }}</td>
            </tr>
            <tr>
                <td>Temps d'attente minimum en queue</td>
                <td class="metric-value time-value">{{ qos_data.get("Temps d'attente minimum en queue (secondes)",
                    0)|format_duration }}</td>
            </tr>
            <tr>
                <td>Temps d'attente maximum en queue</td>
                <td class="metric-value time-value">{{ qos_data.get("Temps d'attente maximum en queue (secondes)",
                    0)|format_duration }}</td>
            </tr>
            <tr>
                <td>Jobs terminés avec succès</td>
                <td class="metric-value"><span style="color: green;">{{ qos_data.get("Jobs terminés avec succès")
                        }}</span></td>
            </tr>
            <tr>
                <td>Jobs échoués</td>
                <td class="metric-value"><span style="color: red;">{{ qos_data.get("Jobs échoués") }}</span></td>
            </tr>
            <tr>
                <td>Jobs préemptés</td>
                <td class="metric-value"><span style="color: orange;">{{ qos_data.get("Jobs préemptés") }}</span>
                </td>
            </tr>
            <tr>
                <td>Jobs soumis</td>
                <td class="metric-value">{{ qos_data.get("Jobs soumis") }}</td>
            </tr>
            <tr>
                <td>Jobs démarrés</td>
                <td class="metric-value">{{ qos_data.get("Jobs démarrés") }}</td>
            </tr>
            <tr>
                <td>Jobs terminés</td>
                <td class="metric-value">{{ qos_data.get("Jobs terminés") }}</td>
            </tr>
            <tr>
                <td>Durée moyenne d'exécution</td>
                <td class="metric-value time-value">{{ qos_data.get("Durée moyenne d'exécution (secondes)",
                    0) | format_duration }}</td>
            </tr>
            <tr>
                <td>Durée médiane d'exécution</td>
                <td class="metric-value time-value">{{ qos_data.get("Durée médiane d'exécution (secondes)",
                    0) | format_duration }}</td>
            </tr>
            <tr>
                <td>Durée minimum d'exécution</td>
                <td class="metric-value time-value">{{ qos_data.get("Durée minimum d'exécution (secondes)",
                    0) | format_duration }}</td>
            </tr>
            <tr>
                <td>Durée maximum d'exécution</td>
                <td class="metric-value time-value">{{ qos_data.get("Durée maximum d'exécution (secondes)",
                    0) | format_duration }}</td>
            </tr>
        </table>
        {% endfor %}
    </div>
    {% endif %}

    <footer>
        <p><em>Rapport généré automatiquement le {{ generation_time }}</em></p>
    </footer>
</body>

</html>